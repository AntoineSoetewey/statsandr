---
title: 'Paper: ''EpiLPS: A fast and flexible Bayesian tool for estimation of the time-varying
  reproduction number'''
author: Antoine Soetewey
date: '2022-10-19'
slug: paper-epilps-a-fast-and-flexible-bayesian-tool-for-estimation-of-the-time-varying-reproduction-number
categories: []
tags:
  - Collaboration
  - Coronavirus
  - R
  - Package
  - Research
  - Statistics
meta_img: blog/paper-epilps-a-fast-and-flexible-bayesian-tool-for-estimation-of-the-time-varying-reproduction-number/images/EpiLPS.PNG
description: How to smooth epidemic curves and estimate the time-varying reproduction number in a flexible way? Read the EpiLPS methods paper (PLoS Computational Biology)
output:
  blogdown::html_page:
    toc: true
    toc_depth: 6  
# draft: true
bibliography: bibliography.bib
---


<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#motivation" id="toc-motivation">Motivation</a></li>
<li><a href="#getting-started" id="toc-getting-started">Getting started</a></li>
<li><a href="#a-simulated-example" id="toc-a-simulated-example">A simulated example</a>
<ul>
<li><a href="#smoothing-the-epidemic-curve-and-estimating-mathcalr_t" id="toc-smoothing-the-epidemic-curve-and-estimating-mathcalr_t">Smoothing the epidemic curve and estimating <span class="math inline">\(\mathcal{R}_t\)</span></a></li>
</ul></li>
<li><a href="#usa-hospitalization-data" id="toc-usa-hospitalization-data">USA hospitalization data</a></li>
<li><a href="#conclusion" id="toc-conclusion">Conclusion</a></li>
<li><a href="#references" id="toc-references">References</a></li>
</ul>
</div>

<p><img src="images/EpiLPS.PNG" style="width:100.0%" /></p>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>A colleague (and friend) of mine recently published a research paper entitled “EpiLPS: A fast and flexible Bayesian tool for estimation of the time-varying reproduction number” in PLoS Computational Biology.</p>
<p>I am not in the habit of sharing research paper to which I did not contribute. Nevertheless, I would like to make an exception with this one because I strongly believe that the method developed in the paper deserves to be known, especially for anyone working in epidemiology.</p>
<p>Below is the motivation behind the article, as well as an illustration on simulated and real data (US hospitalization data). More information can be found in the <a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1010618">paper</a> and on the accompanying <a href="https://epilps.com/">website</a>.</p>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<p>EpiLPS <span class="citation">(<a href="#ref-gressani2022epilps" role="doc-biblioref">Gressani et al. 2022</a>)</span> is a methodology for flexible Bayesian inference of the time-varying reproduction number <span class="math inline">\(\mathcal{R}_t\)</span>; the average number of secondary cases generated by an infected agent at time <span class="math inline">\(t\)</span>. This is a key epidemiological parameter that informs about the transmission potential of an infectious disease and can be used by public health authorities to gauge the effectiveness of interventions and propose an orientation for future control strategies.</p>
<p>This metric has gained in popularity during the SARS-CoV-2 pandemic with wide media coverage as its meaning is easily and intuitively grasped. Put simply, when <span class="math inline">\(\mathcal{R} &lt; 1\)</span>, the signal is encouraging as the epidemic is under control and will eventually vanish. On the contrary, a value of <span class="math inline">\(\mathcal{R} &gt; 1\)</span> means that the disease keeps spreading and infections are witnessing an expansionary impact. Having a robust and reliable tool to compute the reproduction number from infectious disease data is therefore crucial.</p>
<p>A group of researchers in the EpiPose team from Hasselt University (Belgium), Leiden University (The Netherlands), and the University of Bern (Switzerland) have recently developed a new methodology for estimating the instantaneous reproduction number from incidence time series data for a given serial interval distribution (the time elapsed between the onset of symptoms in an infector and the onset of symptoms of secondary cases).</p>
<p>They termed their approach EpiLPS for “<strong>Epi</strong>demiological modeling with <strong>L</strong>aplacian-<strong>P</strong>-<strong>S</strong>plines” as Laplace approximations and P-splines smoothers are key ingredients that form the backbone of the proposed methodology.</p>
<p><br>
<img src="images/Infographic_EpiLPS.png" style="width:100.0%" />
<br></p>
<p>The EpiLPS model assumes that the observed reported cases (by reporting date or date of symptom onset) are governed by a negative binomial distribution. As such, it allows to take the feature of overdispersion into account, contrary to a Poisson model. The epidemic curve is smoothed with P-splines (where posterior estimates of latent variables are computed via Laplace approximations) in a first step and a renewal equation model is used in a second step as a bridge between the reproduction number and the estimated spline coefficients through a “plug-in” method.</p>
<p>The authors also explain the main difference between EpiLPS and EpiEstim, a well established approached for estimating <span class="math inline">\(\mathcal{R}_t\)</span> in real-time developed by <span class="citation">Cori et al. (<a href="#ref-cori2013new" role="doc-biblioref">2013</a>)</span> and make extensive comparisons between the two approaches under different epidemic scenarios.</p>
<p>An interesting feature of EpiLPS is that the user can choose between a fully “sampling-free” path, where model hyperparameters are fixed at their <em>maximum a posteriori</em> (LPSMAP) or a fully stochastic path (LPSMALA) based on a Metropolis-adjusted Langevin algorithm (LPSMALA). Talking about efficiency, routines for Laplace approximations and B-splines evaluations have been coded in C++ and integrated in R via the <a href="https://www.rcpp.org/">Rcpp package</a>, so that the underlying algorithm can be executed in negligible time.</p>
<p>Below, we provide a short example of how to use the EpiLPS routines to estimate <span class="math inline">\(\mathcal{R}_t\)</span>.</p>
</div>
<div id="getting-started" class="section level1">
<h1>Getting started</h1>
<p>The EpiLPS package is available from CRAN (see <a href="https://cran.r-project.org/web/packages/EpiLPS/index.html" class="uri">https://cran.r-project.org/web/packages/EpiLPS/index.html</a>) and can be installed from the R console by typing:</p>
<pre class="r"><code>install.packages(&quot;EpiLPS&quot;)</code></pre>
<p>The package can then be loaded as follows:</p>
<pre class="r"><code>library(&quot;EpiLPS&quot;)</code></pre>
<p>The EpiLPS package structure is fairly simple as it consists in a few routines:</p>
<ul>
<li>The function <code>epilps()</code> is the core routine for fitting the reproduction number.</li>
<li>With <code>plot.epilps()</code>, the user can plot the estimated epidemic curve and <span class="math inline">\(\mathcal{R}_t\)</span>.</li>
<li>Finally, two ancillary routines, <code>episim()</code> and <code>perfcheck()</code> have been developed to essentially reproduce the simulation results of the associated paper.</li>
</ul>
</div>
<div id="a-simulated-example" class="section level1">
<h1>A simulated example</h1>
<p>A set of epidemic data can be simulated with the <code>episim()</code> routine by specifying a serial interval distribution and by choosing among a set of available patterns for the true reproduction number curve (here we choose pattern number 5 corresponding to a rather wiggly curve).</p>
<p>The simulated outbreak is for a duration of 40 days as specified in the <code>endepi</code> option. By setting the option <code>plotsim = TRUE</code>, the routine returns a figure summarizing the incidence time series, a bar plot for the specified serial interval distribution and the true underlying reproduction number curve.</p>
<pre class="r"><code>set.seed(1234)

SI &lt;- c(0.344, 0.316, 0.168, 0.104, 0.068)
simepidemic &lt;- episim(
  serial_interval = SI,
  Rpattern = 5,
  plotsim = TRUE,
  verbose = TRUE,
  endepi = 40
)</code></pre>
<pre><code>## Chosen scenario: 5 &#39;Wiggly then stable Rt&#39;.
## Incidence of cases generated from a Poisson distribution. 
## Total number of days of epidemic: 40.</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Simul-1-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>If you want to have an overview of the generated incidence time series, just type:</p>
<pre class="r"><code>simepidemic$y</code></pre>
<pre><code>##  [1]  10   6  15  24  37  43  54  46  47  28  20   8  10  10   3   5   3   4   6
## [20]   6  15  21  44  75 135 217 329 409 453 487 457 443 297 290 255 246 246 339
## [39] 395 573</code></pre>
<div id="smoothing-the-epidemic-curve-and-estimating-mathcalr_t" class="section level2">
<h2>Smoothing the epidemic curve and estimating <span class="math inline">\(\mathcal{R}_t\)</span></h2>
<p>Let us now use the <code>epilps()</code> routine to smooth the epidemic curve and estimate the reproduction number.</p>
<p>We will do this through LPSMAP (a fully sampling-free approach) and via LPSMALA (a fully stochastic approach relying on a MCMC algorithm with Langevin dynamics), where we specify a chain of length 10000 and a burn-in of size 4000.</p>
<pre class="r"><code>LPSMAP_fit &lt;- epilps(
  incidence = simepidemic$y,
  serial_interval = SI,
  tictoc = TRUE
)</code></pre>
<pre><code>## Inference method chosen: LPSMAP. 
## CI for LPSMAP computed via lognormal posterior approx. of Rt.Total number of days: 40. 
## Mean Rt discarding first 7 days: 1.327.
## Mean 95% CI of Rt discarding first 7 days: (1.164,1.527) 
## Elapsed real time (wall clock time): 0.261 seconds.</code></pre>
<pre class="r"><code>LPSMALA_fit &lt;- epilps(
  incidence = simepidemic$y, serial_interval = SI,
  method = &quot;LPSMALA&quot;, chain_length = 10000, burn = 4000
)</code></pre>
<pre><code>## Inference method chosen: LPSMALA with chain length 10000 and warmup 4000.
## MCMC acceptance rate: 56.41%. 
## Geweke z-score &lt; 2.33 for:  32 / 33  variables. 
## Total number of days: 40. 
## Mean Rt discarding first 7 days: 1.326.
## Mean 95% CI of Rt discarding first 7 days: (1.117,1.555). 
## Timing of routine not requested.</code></pre>
<p>After execution, each routine prints in the console a brief summary of the method that has been requested by the user.</p>
<p>For LPSMALA, it summarizes the chain length, the acceptance rate (should be around 56%) and other basic information. As can be seen from the printed output, the mean reproduction number for the simulated epidemic is around 1.33.</p>
<p>We can now use, say, the <code>LPSMALA_fit</code> object together with the <code>plot()</code> routine to obtain the smoothed epidemic curve and the estimated reproduction number (by default the credible interval is at a 5% level of significance but this can be changed by the user).</p>
<pre class="r"><code>days &lt;- seq(8, 40)

#--- Smoothed epidemic curve
gridExtra::grid.arrange(
  plot(LPSMALA_fit,
    plotout = &quot;epicurve&quot;, incibars = TRUE, themetype = &quot;light&quot;,
    epicol = &quot;darkgreen&quot;, cicol = rgb(0.3, 0.73, 0.3, 0.2),
    epititle = &quot;Smoothed epidemic curve&quot;, titlesize = 13, barwidth = 0.25
  ),

  #--- Estimated reproduction number
  plot(LPSMALA_fit,
    plotout = &quot;rt&quot;, theme = &quot;light&quot;, rtcol = &quot;black&quot;,
    titlesize = 13, Rtitle = &quot;Estimated R (LPSMALA)&quot;
  ),
  nrow = 1, ncol = 2
)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Simul-4-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>The figure can be customized in various ways:</p>
<ul>
<li>Users can specify the theme under <code>themetype</code>. Available options are <code>gray</code> (the default), <code>classic</code>, <code>light</code> and <code>dark</code>.</li>
<li>Other choices, such as whether or not to show the incidence bars, the color of the credible interval envelope, the color of the smoothed epidemic curve and the estimated reproduction number are also available.</li>
</ul>
<p>The figure above was generated within the <a href="/blog/graphics-in-r-with-ggplot2/"><code>ggplot2</code> package</a>, but there is also another way of extracting information directly from the <code>LPSMAP_fit</code> and <code>LPSMALA_fit</code> objects. In fact, the estimated reproduction number values and their associated credible interval for each day can be extracted and plotted.</p>
<p>Below, we make the exercise and plot the estimated <span class="math inline">\(\mathcal{R}_t\)</span> obtained with LPSMAP and LPSMALA, respectively and compare it with the true underlying reproduction number curve. The fit is quite good.</p>
<pre class="r"><code>par(mfrow = c(1, 2))

#--- LPSMAP vs target R
plot(days, sapply(days, simepidemic$Rtrue),
  type = &quot;l&quot;, lwd = 2, ylim = c(0, 4),
  ylab = &quot;Estimated R&quot;, xlab = &quot;Time&quot;
)
polygon(
  x = c(days, rev(days)), y = c(
    LPSMAP_fit$epifit$R95CI_low[8:40],
    rev(LPSMAP_fit$epifit$R95CI_up[8:40])
  ),
  col = rgb(0.23, 0.54, 1, 0.3), border = NA
)
lines(days, LPSMAP_fit$epifit$R_estim[8:40], type = &quot;l&quot;, col = &quot;cornflowerblue&quot;, lwd = 2)
lines(days, sapply(days, simepidemic$Rtrue), type = &quot;l&quot;, lwd = 2)

grid(nx = 10, ny = 10)
legend(&quot;topright&quot;,
  lty = c(1, 1), lwd = c(2, 2),
  col = c(&quot;black&quot;, &quot;blue&quot;, rgb(0.23, 0.54, 1, 0.3)),
  c(&quot;Target R&quot;, &quot;LPSMAP&quot;, &quot;LPSMAP 95% CI&quot;), bty = &quot;n&quot;, cex = 0.9
)

#--- LPSMALA vs target R
plot(days, sapply(days, simepidemic$Rtrue),
  type = &quot;l&quot;, lwd = 2, ylim = c(0, 4),
  ylab = &quot;Estimated R&quot;, xlab = &quot;Time&quot;
)
polygon(
  x = c(days, rev(days)), y = c(
    LPSMALA_fit$epifit$R95CI_low[8:40],
    rev(LPSMALA_fit$epifit$R95CI_up[8:40])
  ),
  col = rgb(1, 0.23, 0.31, 0.3), border = NA
)
lines(days, LPSMALA_fit$epifit$R_estim[8:40], type = &quot;l&quot;, col = &quot;red&quot;, lwd = 2)
lines(days, sapply(days, simepidemic$Rtrue), type = &quot;l&quot;, lwd = 2)

grid(nx = 10, ny = 10)
legend(&quot;topright&quot;,
  lty = c(1, 1), lwd = c(2, 2),
  col = c(&quot;black&quot;, &quot;red&quot;, rgb(1, 0.23, 0.31, 0.3)),
  c(&quot;Target R&quot;, &quot;LPSMALA&quot;, &quot;LPSMALA 95% CI&quot;), bty = &quot;n&quot;, cex = 0.9
)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/Simul-5-1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>You can access, say, the results of the last week of the epidemic by typing:</p>
<pre class="r"><code># Estimated R of the last week (with LPSMAP)
round(tail(LPSMAP_fit$epifit[, 1:4], 7), 3)</code></pre>
<pre><code>##    Date R_estim R95CI_low R95CI_up
## 34   34   0.708     0.663    0.756
## 35   35   0.724     0.676    0.775
## 36   36   0.809     0.755    0.868
## 37   37   0.971     0.908    1.039
## 38   38   1.205     1.135    1.279
## 39   39   1.461     1.384    1.541
## 40   40   1.671     1.557    1.794</code></pre>
<pre class="r"><code># Estimated mean number of cases of the last week (with LPSMAP)
round(tail(LPSMAP_fit$epifit[, 5:7], 7))</code></pre>
<pre><code>##    mu_estim mu95CI_low mu95CI_up
## 34      284        225       357
## 35      254        202       319
## 36      248        196       312
## 37      267        211       338
## 38      319        253       404
## 39      411        325       520
## 40      552        394       774</code></pre>
</div>
</div>
<div id="usa-hospitalization-data" class="section level1">
<h1>USA hospitalization data</h1>
<p>To illustrate EpiLPS on real data, we download hospitalization data from the <code>COVID19</code> package for the USA in the period ranging from 2021-09-01 to 2022-09-01 and apply the <code>epilps()</code> routine to estimate the reproduction number.</p>
<pre class="r"><code>install.packages(&quot;COVID19&quot;)
library(&quot;COVID19&quot;)</code></pre>
<pre class="r"><code># Get data and specify serial interval distribution
USADat &lt;- COVID19::covid19(
  country = &quot;US&quot;, level = 1, start = &quot;2021-09-01&quot;,
  end = &quot;2022-09-01&quot;, verbose = FALSE
)

si &lt;- c(0.344, 0.316, 0.168, 0.104, 0.068)

inciUSA &lt;- USADat$hosp
dateUSA &lt;- USADat$date</code></pre>
<p>We use the <code>epilps()</code> routine with method LPSMAP (default) and plot the smoothed epidemic curve and the estimated reproduction number with a 95% credible interval.</p>
<pre class="r"><code>epifit &lt;- epilps(incidence = inciUSA, serial_interval = si, K = 20)</code></pre>
<pre><code>## Inference method chosen: LPSMAP. 
## CI for LPSMAP computed via lognormal posterior approx. of Rt.Total number of days: 366. 
## Mean Rt discarding first 7 days: 0.994.
## Mean 95% CI of Rt discarding first 7 days: (0.983,1.005) 
## Timing of routine not requested.</code></pre>
<pre class="r"><code>gridExtra::grid.arrange(
  plot(epifit,
    dates = dateUSA, datelab = &quot;3m&quot;,
    plotout = &quot;epicurve&quot;, incibars = FALSE, themetype = &quot;light&quot;,
    epicol = &quot;darkgreen&quot;, cicol = rgb(0.3, 0.73, 0.3, 0.2),
    epititle = &quot;USA smoothed epidemic curve&quot;, titlesize = 13
  ),
  plot(epifit,
    dates = dateUSA, datelab = &quot;3m&quot;,
    plotout = &quot;rt&quot;, theme = &quot;light&quot;, rtcol = &quot;black&quot;,
    titlesize = 13, Rtitle = &quot;USA Estimated R&quot;
  ),
  nrow = 1, ncol = 2
)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/USA-2-1.png" width="100%" style="display: block; margin: auto;" /></p>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>Thanks for reading.</p>
<p>I hope you will find the method developed in the paper as useful as I do. Feel free to reach out to me and to the authors if you happen to use it for your own research.</p>
<p>As always, if you have a question or a suggestion related to the topic covered in this article, please add it as a comment so other readers can benefit from the discussion.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-cori2013new" class="csl-entry">
Cori, Anne, Neil M Ferguson, Christophe Fraser, and Simon Cauchemez. 2013. <span>“A New Framework and Software to Estimate Time-Varying Reproduction Numbers During Epidemics.”</span> <em>American Journal of Epidemiology</em> 178 (9): 1505–12.
</div>
<div id="ref-gressani2022epilps" class="csl-entry">
Gressani, Oswaldo, Jacco Wallinga, Christian L Althaus, Niel Hens, and Christel Faes. 2022. <span>“EpiLPS: A Fast and Flexible Bayesian Tool for Estimation of the Time-Varying Reproduction Number.”</span> <em>PLoS Computational Biology</em> 18 (10): e1010618. <a href="https://doi.org/10.1371/journal.pcbi.1010618">https://doi.org/10.1371/journal.pcbi.1010618</a>.
</div>
</div>
</div>
